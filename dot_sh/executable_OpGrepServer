#! /usr/bin/env bash
rund=$(dirname $0)/run
mkdir -p $rund

mkfifo $rund/$$.fifo
trap "rm $rund/$$.fifo" EXIT

echo $rund/$$.fifo
exec {fifofd}<>$rund/$$.fifo

function init {
    file=$1
    cont=$(($2-2))
    agas="${@:3}"
    maxi=$(ag "$agas" $file | wc -l)
    curi=0
    next
}

function next {
    curi=$(($curi % $maxi + 1))
    rang="rmin = \$1 - $cont/2; rmax = \$1 + $cont/2; if (rmin < 1) { rmax -= (rmin - 1); rmin = 1; }  printf \"-r %d:%d -H %d\", rmin, rmax, \$1"
    bata=$(ag --numbers "$agas" $file | awk -F: "FNR == $curi { $rang }")
    echo "OK"
}

function preview {
    if [[ -z $bata ]]; then
        echo "Loading preview..."
        return
    fi
    bat -n --color=always $bata $file
}

function getSelectedLineNumber {
    line=$(ag --numbers "$agas" $file | awk -F: "FNR == $curi { print \$1 }")
    echo $line
}

while read -u $fifofd -a arra; do
    responseFifo="${arra[0]}"
    cmd=${arra[1]}
    case $cmd in
        "init") init "${arra[@]:2}" > "$responseFifo";;
        "next") next > "$responseFifo";;
        "preview") preview > "$responseFifo";;
        "getSelectedLineNumber") getSelectedLineNumber > "$responseFifo";;
        "shutdown") echo "OK" > "$responseFifo"; exit;;
        *) echo OpGrepServer does not recognize command $cmd > "$responseFifo";;
    esac
done
