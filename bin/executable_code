#! /usr/bin/env bash

rund=$(dirname $0)/run
mkdir -p "$rund"
. ~/.sh/logging.sh "$rund"

sessionLocation="${1:-$(pwd)}"

function launch {
    remote="${$1%:*}"
    [[ "$remote" == "$1" ]] && remote=""
    folder="$(realpath ${1#*:})"
    sesl="${remote:+$remote:}$folder"
    ~/.sh/WriteLeastRecentlyUsed "$rund/sessions" "$sesl"
    if [[ -n $remote ]]; then
        rdir="bin/sessions-from/${remote}"
        sess="$remote:$rdir/sessions"
        ssh "$remote" "mkdir -p '$rdir'"
        scp "$rund/sessions" "$sess"
        ssh "$remote" "~/.sh/Code '${sesl#*:}' '$sess'"
        scp "$sess" "$rund/sessions"
    else
        ~/.sh/Code "$sesl" "$rund/sessions"
    fi
    next=$(tail -n 1 "$rund/sessions")
    [[ "$next" == "$sesl" ]] && return
    launch "$next"
}

launch "$sessionLocation"
